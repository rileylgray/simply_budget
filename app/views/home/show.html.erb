<%# Bootstrap 5 & jQuery CDN %>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<%# Ruby: Calculate this month's totals %>
<%
  start_of_month = Date.current.beginning_of_month
  end_of_month = Date.current.end_of_month

  monthly_income = Income.where(user: current_user, received_on: start_of_month..end_of_month).sum(:amount)
  monthly_expenses = Expense.where(user: current_user, spent_on: start_of_month..end_of_month).sum(:amount)
  remaining = [monthly_income - monthly_expenses, 0].max
%>
<div class="container mt-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-4">Spending vs Income (This Month)</h5>
      <canvas id="spendingIncomePie" width="400" height="400"></canvas>
      <% if monthly_income > 0 && (monthly_expenses.to_f / monthly_income.to_f) < 0.5 %>
        <div class="text-center mt-4">
          <img src="https://cdn.pixabay.com/photo/2016/03/31/19/56/penguin-1297273_1280.png"
               alt="Cool Penguin"
               style="max-width: 150px; width: 100%;"
               title="You’re cool with your money!">
          <div class="fw-bold mt-2 text-success">Nice! You’ve spent less than 50% of your income!</div>
        </div>
      <% end %>
    </div>
  </div>
</div>



<script>
  $(function() {
    const ctx = document.getElementById('spendingIncomePie').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Spent', 'Remaining Income'],
        datasets: [{
          data: [<%= monthly_expenses %>, <%= remaining %>],
          backgroundColor: [
            'rgba(220, 53, 69, 0.7)',    // Bootstrap danger
            'rgba(25, 135, 84, 0.7)'     // Bootstrap success
          ],
          borderColor: [
            'rgba(220, 53, 69, 1)',
            'rgba(25, 135, 84, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                let value = context.parsed || 0;
                return `${label}: $${value.toLocaleString()}`;
              }
            }
          }
        }
      }
    });
  });
</script>